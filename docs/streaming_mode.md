# Streaming Mode of FlexFringe

The streaming mode of FlexFringe was first developed by Robert Baumgartner and was later adapted by Clinton Cao for a specific use case. The adapted version of the streaming mode allows you to continuously update a state machine based on the provided input traces. In the current implementation, FlexFringe is started as a daemon that runs on the background and waits for input traces. FlexFringe updates the model using each input trace and then outputs a new model (in DOT format) to the specified output directory. 

## Building Streaming Mode 
To build the streaming mode of FlexFringe, you can use the same build process as the default version. Just follow the instructions in the README file to build FlexFringe.

## Runnning Streaming Mode
To run the streaming version of FlexFringe (i.e.,  the daemon), you can simply run the following command at the root of this repository:

```bash
$ ./flexfringe --ini ini/css-streaming.ini
```

This starts the FlexFringe daemon in the background and waits for input traces. The current implementation uses a named pipe to receive input traces. Specifically, it creates a `flexfringe_fifo` file in the `/tmp/` directory. This is used for inter-process communication between your program and the FlexFringe daemon.

## Sending Input Traces to FlexFringe
To forward your input traces to FlexFringe to update the model, you can use the following command:

```bash
$ echo PATH/TO/YOUR_TRACE_FILE.txt --out_name YOUR_NAMING_FORMAT > /tmp/flexfringe_fifo
```

Once this command is executed, the daemon will start the process the input traces in the your trace file. As you might have noticed, the daemon reads the provided trace file instead of directly processing the input traces via the named pipe. The reason behind the design choice is because in my work (MISH), we have batches of traces generated based on the set of test cases run by an evolutionary algorithm. 

As the number test cases is different every time, we need to built logic in FlexFringe that waits and checks whether we have gotten all the inputs. To simplify things (making sure that we have all the inputs for a batch), I opted to send a file and let FlexFringe read the file instead. 

The `--out_name` flag is used to specify the naming format of the model file(in DOT format). This is handy if you would like to analyze the intermediate models generated by FlexFringe. For example, if you use `--out_name 0`, FlexFringe will output a model file name 'model_batch_nr_0.dot'. 

By default, FlexFringe writes the model files to the working directory where the FlexFringe daemon was started. If you started using the command listed above, then it will write to the root of the FlexFringe repository. You can change the output directory by modifying the the `OUTPUT_DIRECTORY` variable in the `ini/css-streaming.ini` file or by passing it as a command line argument when starting the daemon.

## Computing Fitness Using Streaming Mode
For the implementation of the streaming mode, I have added the feature for computing fitness of input traces. This is because I needed the fitness values to guide the test-case generation process of an evoltionary algorithm. The command for computing fitness is similar to updating the model, the only difference is that you need to add the `--fitness` flag:

```bash
$ echo PATH/TO/YOUR_TRACE_FILE.txt --out_name YOUR_NAMING_FORMAT --fitness > /tmp/flexfringe_fifo
```

FlexFringe parses for the `fitness` flag to determine whether to compute the fitness of the input traces or not. FlexFringe computes a fitness value for each trace in the trace file (i.e., if you provide N traces, you get N fitness values). The fitness values are written to a file named `fitness_YOUR_NAMING_FORMAT.txt` in the same working directory where the FlexFringe daemon was started. The fitness values are written in the same order as the input traces.

You can figure which fitness function to use using modifying the `FITNESS_TYPE` variable in the `ini/css-streaming.ini` file. The default fitness function is `avg`, which is computed as follow: `number of states visited by trace / total sum of state sizes of the visited states`. For my work, I wanted to have a higher fitness for traces that visits more infrequent states, hence the formula is "flipped". You can also add your own fitness function modifying the `source/ea_utils.h` and `source/ea_utils.cpp` files.


## Seeing Logs of Streaming Mode
As the streaming mode starts a daemon, the default logging does not work like in the default version of FlexFringe (it is not written to `flexfringe.log`). Instead, the logs are written to `/tmp/flexfringe_log.txt`. By looking at the logs, you can see which part of the streaming mode was executed, which might be handy when flexfringe crashes. You can also add additional log statments. Make sure you see in the `main.cpp` how the logging is done. And the logging mechanism can definitely be improved.

## Stopping the FlexFringe Daemon
To stop the FlexFringe daemon, you can simply kill the process using the following command:

```bash
$ killall flexfringe --ini ini/css-streaming.ini
```

Currently, the daemon can only be stopped by killing the process. 